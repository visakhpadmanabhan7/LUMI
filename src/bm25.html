<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BM25 Query Pair Dropdown</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            justify-content: center;
            height: 100vh;
            background-color: #f0f0f0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        select {
            padding: 10px;
            margin-right: 20px;
            font-size: 16px;
        }
        .query-display {
            padding: 10px;
            font-size: 16px;
            background-color: #e0e0e0;
            border-radius: 4px;
            min-width: 200px;
        }
        #query_text {
            width: 100%;
            height: 40px; /* Reduced height */
            padding: 10px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-top: 10px; /* Adjusted margin */
            resize: vertical; /* Allows vertical resizing */
        }
        #article_text, #comm_text{
            width: 100%;
            height: 90px; /* Reduced height */
            padding: 10px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-top: 10px; /* Adjusted margin */
            resize: vertical; /* Allows vertical resizing */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f0f0f0;
        }
        #venn {
            width: 800px;
            height: 600px;
            margin-top: 20px;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            padding: 10px;
            font: 15px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Select a Query Pair</h1>
        <div class="form-group">
            <label for="query_pair">Query Pair:</label>
            <select id="query_pair" name="query_pair" onchange="fetchQueryDetails()">
                <option value="">Select a query pair</option> <!-- Default empty option -->
                {% for pair in query_pairs %}
                    <option value="{{ pair }}">{{ pair }}</option>
                {% endfor %}
            </select>
            <div id="selected_query" class="query-display">Select a query pair</div>
        </div>
        <textarea id="query_text" readonly></textarea>

        <h2>Retrieval Details</h2>
        <table id="query_details">
            <thead>
                <tr>
                    <th>Ground Truth</th>
                    <th>Predicted</th>
                    <th>Precision</th>
                    <th>Recall</th>
                    <th>F2 Score</th>
                </tr>
            </thead>
            <tbody>
                <!-- Table rows will be added dynamically via JavaScript -->
            </tbody>
        </table>
        <h2>Article Details</h2>
        <div class="form-group">
            <label for="article_id">Article ID:</label>
            <select id="article_id" name="article_id" onchange="fetchArticle()">
                <option value="">Select an article ID</option> <!-- Default empty option -->
            </select>
            <div id="selected_article" class="query-display">Select an article ID</div>
        </div>
        <h3>Article Text</h3>

        <textarea id="article_text" readonly></textarea>


<!--        <h3>Commentary Text</h3>-->

<!--        <textarea id="comm_text" readonly></textarea>-->
        <h4>Explainability</h4>
        <ul>
            <li>        <h5>Article</h5></li>

        </ul>
        <div id="venn"></div>

        <!-- Venn diagram container -->
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/venn.js@0.2.20/build/venn.min.js"></script>
    <script>
        function fetchQueryDetails() {
            const select = document.getElementById('query_pair');
            const queryPair = select.value;

            if (queryPair === "") {
                document.getElementById('selected_query').innerText = "Select a query pair";
                document.getElementById('query_text').value = "";
                clearQueryDetails();
                return;
            }

            fetch('/get_query_details', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ pair: queryPair })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('selected_query').innerText = queryPair;
                document.getElementById('query_text').value = data.query_text;
                populateQueryDetails(data.query_details);
            })
            .catch(error => console.error('Error:', error));

            fetch('/get_article_ids', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ pair: queryPair })
            })
            .then(response => response.json())
            .then(data => {
                populateArticleIds(data.article_ids);
            })
            .catch(error => console.error('Error:', error));
        }

        function populateQueryDetails(details) {
            const tableBody = document.querySelector('#query_details tbody');
            tableBody.innerHTML = '';

            details.forEach(detail => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${detail.article_num}</td>
                    <td>${detail.predicted}</td>
                    <td>${detail.precision}</td>
                    <td>${detail.recall}</td>
                    <td>${detail.f2}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function clearQueryDetails() {
            const tableBody = document.querySelector('#query_details tbody');
            tableBody.innerHTML = '';
        }

        function populateArticleIds(articleIds) {
            const select = document.getElementById('article_id');
            select.innerHTML = '<option value="">Select an article ID</option>'; // Clear previous options

            articleIds.forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = id;
                select.appendChild(option);
            });
        }

        function fetchArticle() {
            const select = document.getElementById('article_id');
            const articleId = select.value;

            const select_pair = document.getElementById('query_pair');
            const queryPair = select_pair.value;

            if (articleId === "") {
                document.getElementById('selected_article').innerText = "Select an article ID";
                document.getElementById('article_text').value = "";
                return;
            }

            fetch('/get_article', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ article_id: articleId }) // Sending articleId as pair for simplicity
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('selected_article').innerText = articleId;
                document.getElementById('article_text').value = data.article_text;
                // document.getElementById('comm_text').value = data.commentary_text;
                fetchTokens();
            })
            .catch(error => console.error('Error:', error));
        }

        function fetchTokens() {
            const select = document.getElementById('article_id');
            const articleId = select.value;

            const select_pair = document.getElementById('query_pair');
            const queryPair = select_pair.value;

            fetch('/get_tokens', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ pair: queryPair, article_id: articleId })
            })
            .then(response => response.json())
            .then(data => {
                const common_tokens = data.common_tokens;
                const article_tokens = data.article_tokens;
                const query_tokens = data.query_tokens;


                // Create Venn diagram
                createVennDiagram(article_tokens, query_tokens, common_tokens);
            })
            .catch(error => console.error('Error:', error));
        }

        function createVennDiagram(articleTokens, queryTokens, commonTokens) {
    const sets = [
        { sets: ['Query Tokens'], size: queryTokens.length, label: 'Query Tokens:' + queryTokens.length },
        { sets: ['Article Tokens'], size: articleTokens.length, label: 'Article Tokens: ' + articleTokens.length },
        { sets: ['Query Tokens', 'Article Tokens'], size: commonTokens.length, label: 'Common Tokens: ' + commonTokens.length }
    ];

    const chart = venn.VennDiagram();
    const div = d3.select("#venn");

    div.datum(sets).call(chart);

    const tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    div.selectAll("path")
        .style("stroke-opacity", 0)
        .style("stroke", "#fff")
        .style("stroke-width", 0);

    div.selectAll("g")
        .on("mouseover", function(d, i) {
            tooltip.transition()
                .duration(200)
                .style("opacity", .9);

            let tokens;
            let heading;

            if (i === 0) {
                tokens = queryTokens;
                heading = "Query Tokens: TF ";
            } else if (i === 1) {
                tokens = articleTokens;
                heading = "Article Tokens: TF ";
            } else if (i === 2) {
                tokens = commonTokens;
                heading = "Common Tokens: IDF ";
            }

            tooltip.html(`<strong>${heading}</strong><br>${tokens.join("<br>")}`)
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY - 28) + "px");
        })
        .on("mouseout", function(d) {
            tooltip.transition()
                .duration(500)
                .style("opacity", 0);
        });
}
    </script>
</body>
</html>
